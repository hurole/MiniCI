# 功能规范：部署时懒加载提交记录

**功能分支**: `002-lazy-fetch-commits`
**创建时间**: 2026年2月7日
**状态**: 草稿
**输入**: 用户描述："当前创建新部署时 会直接请求获取 main 分支的提交记录，当前记录很多的时候请求会变慢，所以避免打开创建部署弹窗时就立刻请求默认分支上的提交记录，也不要自动选中分支，要等用户选中分支后，才去获取选中分支的提交记录。"

## 澄清事项

### 会话 2026-02-07

- Q: 为了优化性能，应该获取多少条提交记录？ → A: 限制为最近的 10 条提交记录。
- Q: 如何处理超过初始 10 条的更早的提交记录？ → A: 实现无限滚动加载，每次加载额外的 10 条记录（使用下拉组件的滚动监听）。
- Q: 切换分支时，如果已选中了一个提交，该如何处理？ → A: 立即重置/清空已选中的提交记录。
- Q: 提交记录初始加载的数量是多少？ → A: 初始加载 10 条，每次滚动加载 10 条（每页大小统一为 10）。
- Q: 重新打开部署弹窗时，是否应记住上次选择的分支？ → A: 否，始终重置为空，要求用户显式选择。

## 用户场景与测试 *(必填)*

### 用户故事 1 - 打开部署弹窗 (优先级: P1)

用户打开部署创建弹窗。界面应立即加载，无需等待任何耗时的网络请求（特别是提交历史记录）。不应预先选中任何分支，以防止意外部署或不必要的数据获取。

**优先级理由**: 即时的 UI 反馈对感知的性能至关重要。防止初始的重型请求解决了报告的缓慢问题。

**独立测试**: 可以通过打开弹窗并（通过网络检查器）验证未发起提交获取 API 调用且未选中任何分支来进行完全测试。

**验收场景**:

1. **Given** 用户在部署页面，**When** 点击“创建部署”，**Then** 弹窗立即打开。
2. **Given** 弹窗已打开，**When** 用户检查“分支”选择字段，**Then** 它是空的（未选中默认分支）。
3. **Given** 弹窗已打开，**When** 用户检查网络活动，**Then** 未发起获取 'main'（或任何分支）提交记录的请求。

---

### 用户故事 2 - 选择分支并获取提交记录 (优先级: P1)

用户从列表中选择一个特定分支。只有在此时，系统才会获取该特定分支的提交历史记录。

**优先级理由**: 确保仅在需要时获取数据（懒加载），减少服务器负载和客户端等待时间（对于甚至可能不需要默认分支的用户）。

**独立测试**: 可以通过选择一个分支并观察 API 调用仅在那时触发，并且提交记录随即填充来进行测试。

**验收场景**:

1. **Given** 弹窗已打开且未选中分支，**When** 用户选择一个分支（例如 "feature-x"），**Then** 提交列表区域显示加载状态。
2. **Given** 分支 "feature-x" 被选中，**When** 网络请求完成，**Then** 显示 "feature-x" 的提交历史记录。
3. **Given** 提交列表已填充，**When** 用户选择一个提交并点击“部署”，**Then** 部署流程以正确的分支和提交开始。

## 需求 *(必填)*

### 功能需求

- **FR-001**: 部署创建弹窗在打开时，**绝不**能自动发起获取默认分支（例如 'main'）提交历史记录的请求。
- **FR-002**: 部署创建弹窗在打开时，**绝不**能自动默认选中任何分支。
- **FR-003**: 系统**必须**提供一种机制，供用户从可用分支列表中手动选择分支。
- **FR-004**: 系统**必须**仅在用户明确选择分支后才获取提交历史记录。
- **FR-005**: 系统**必须**在选择分支后的提交获取期间，在提交列表区域显示加载指示器。
- **FR-006**: 一旦选定分支的请求成功，系统**必须**用获取的数据填充提交列表。
- **FR-007**: 系统**必须**将提交历史记录的**初始**获取限制为最近的 10 条。
- **FR-008**: 系统**必须**支持分页或无限滚动，以便在用户滚动提交列表底部时加载更多提交记录。
- **FR-009**: 后续的每次加载**必须**获取额外的 10 条提交记录。
- **FR-010**: 当用户更改所选分支时，系统**必须**自动清除任何当前选中的提交记录。

### 关键实体 *(如果功能涉及数据)*

- **分支选择**: 用于选择目标分支的用户输入字段。
- **提交历史**: 与所选分支关联的提交记录列表。

## 边界情况

- **网络失败**: 如果分支选择后的提交获取失败，系统**必须**显示错误消息并允许用户重试。
- **空分支**: 如果所选分支没有提交历史记录（例如一个新的孤立分支），系统**必须**显示“未找到提交”状态，而不是无限加载。
- **分支删除**: 如果在加载分支列表和用户选择它的时间之间，分支被远程删除，获取将失败。系统**必须**优雅地处理此情况（错误消息）。

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 打开部署弹窗触发 0 次提交历史网络请求。
- **SC-002**: 部署弹窗的可交互时间（点击后）低于 200ms（主要由 UI 渲染决定，而非网络）。
- **SC-003**: 100% 的提交获取请求对应于用户的明确分支选择。
